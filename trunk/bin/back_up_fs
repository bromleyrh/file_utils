#!/bin/sh

# back_up_fs: back up a filesystem

. ~/lib/lock_mtab || exit 1

backup_dst=/backup_dst
backup_fs=ext4
backup_src=/backup_src
dry=0
rsync_opts="-avX --delete-before --progress"

while [[ $1 ]]; do
    if [[ ($1 == "-dst") && $2 ]]; then
        backup_dst=$2
        shift
    elif [[ ($1 == "-fs") && $2 ]]; then
        backup_fs=$2
        shift
    elif [[ ($1 == "-h") || ($1 == "--help") ]]; then
        read -d '' help << EOF
back_up_fs: back up a filesystem

  Usage: back_up_fs [-dst BACKUP_DST] [-fs BACKUP_FS] [-n] [-src BACKUP_SRC]
EOF
        echo "$help"
        exit 0
    elif [[ $1 == "-n" ]]; then
        dry=1
    elif [[ ($1 == "-src") && $2 ]]; then
        backup_src=$2
        shift
    fi
    shift
done

cd $backup_dst
lock_mtab
if ! grep " $backup_dst $backup_fs " /etc/mtab &>/dev/null; then
	unlock_mtab
    echo "No filesystem of type $backup_fs is mounted at $backup_dst," \
        "according to /etc/mtab"
    exit 1
fi
unlock_mtab

tmp=`which rsync 2>/dev/null`
if [[ (-z $tmp) || (! -x $tmp) ]]; then
    echo "Could not find rsync"
    exit 1
fi

rsync_opts="$rsync_opts $backup_src/ $backup_dst"

if [[ $dry == 1 ]] ; then
    echo "Performing test run of the synchronization of $backup_dst with" \
        "$backup_src"
    rsync -n $rsync_opts
    exit
fi

echo "Synchronizing $backup_dst with $backup_src"
exec rsync $rsync_opts

# vi: set noexpandtab sw=4 ts=4:
